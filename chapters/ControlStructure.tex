The structure of the proposed control strategy is presented in \cref{fig:tikzControlStrat} and includes the aforementioned inner fast loop and outer slow loop:  

\begin{figure}[h!]
	\centering
	\resizebox{\columnwidth}{!}{
	\input{TikzFigures/TikzControlStructure}}
	\caption{Control strategy including control for fast and slow dynamics.}
	\label{fig:tikzControlStrat}
\end{figure}

\subsection{Outer Loop}\label{subsec:OuterLoop}

We will first address the outer LQR controller. This is an optimal controller that, in its continuous, LTI, infinite-horizon form, is given by the solution to the Lagrange problem:

\begin{equation}\label{eq:LagrangeProblem}
		J = \int_{t_0}^{\infty} \big(x^T(t)Qx(t) + u^T(t)Ru(t)\big)dt
\end{equation} 

constrained by the dynamics:

\begin{equation}\label{eq:LQRDynamicsConstraint}
	\begin{gathered}
		\dot{x}(t) = Ax(t) + Bu(t) \\
		y(t) = Cx(t) \\
		x(t_0) = x_0
	\end{gathered} 
\end{equation}

Where $(A,B)$ is controllable, $(A,C)$ is observable, and $Q,R$ are positive semidefinite matrices. The optimal solution to this problem is given by minimising the Hamiltonian $\mathcal{H}$ \cite{Liberzon2012}:

\begin{equation}\label{eq:Hamiltonian}
	\begin{gathered}
			\mathcal{H} = \lambda^T(t) f(x(t),u(t)) - \mathcal{L}(x(t),u(t)) \\
			f(x(t),u(t)) = A(t)x(t) + B(t)u(t) \\
			\mathcal{L}(x(t),u(t)) =  x^T(t)Q(t)x(t) - u^T(t)R(t)u(t)
	\end{gathered}
\end{equation}

which gives a solution of the type:

\begin{equation}\label{eq:LQRSolution}
	u^*(t) = -RB^TPx^*(t) = -Kx^*(t)
\end{equation}

where $P$ is the solution to the algebraic Riccatti equation:

\begin{equation}\label{eq:ARE}
	PA + A^TP + Q - PBR^{-1}B^TP = 0
\end{equation}

However, the standard LQR has several major issues. It only regulates to the origin, it does not have integral action, and it does not reject state disturbances. We therefore, as in Pannocchia et al. \cite{Pannocchia2015a}, rewrite the above as a discrete problem in deviation variables and solve:

\begin{equation}\label{eq:LagrangeProblemDeviation}
	\begin{gathered}
	J = \sum_{k_0}^{\infty} \big(\zeta(k)^TQ\zeta(k) + \tilde{u}(k)^TR\tilde{u}(k)\big) \\
	\zeta = \begin{bmatrix}	x(k)-x(k-1) \\ y(k)-r(k) \end{bmatrix}, \quad \tilde{u}(k) = u(k)-u(k-1) 
	\end{gathered}
\end{equation} 

where the constraining dynamics are given by:

\begin{equation}\label{eq:VelocityMatrices}
	\begin{gathered}
		\zeta(k+1) = \tilde{A}\zeta(k) + \tilde{B}\tilde{u}(k) \\
		\tilde{A} = \begin{bmatrix} A & 0 \\ CA & I	\end{bmatrix}, \ 
		\tilde{B} = \begin{bmatrix} B \\ CB	\end{bmatrix}, \ \tilde{C} = \begin{bmatrix} 0 & I	\end{bmatrix}
	\end{gathered}
\end{equation}

and the optimal control policy becomes:

\begin{equation}\label{eq:OptimalVF-LQRPolicy}
\begin{gathered}
\tilde{u}^*(k)  = -\tilde{K}\tilde{x}^*(k) \\
\tilde{K} = (\tilde{B}^TP\tilde{B}-R)^{-1}(\tilde{B}^TP\tilde{A}) \\
u^*(k) = \sum_{i=1}^{k} \tilde{u}^*(i)
\end{gathered}
\end{equation}

where $P$ is now the solution to the \textit{discrete} algebraic Riccatti equation:

\begin{equation}\label{eq:DARE}
	-Q = \tilde{A}^TP\tilde{A} - P - (\tilde{A}^TP\tilde{B})(\tilde{B}^TP\tilde{B}+R)^{-1}(\tilde{B}^TP\tilde{A})
\end{equation}

This control policy clearly has tracking as $\zeta(k+1) = 0$ implies $y(k+1)-r(k+1) = 0$, and has integral action by virtue of its incremental form. However, it still lacks disturbance rejection. Assuming that we are only concerned with optimal control of the disturbance-free subsystem, complete rejection of the state disturbance $\delta(k)$ can then be achieved by augmenting \cref{eq:OptimalVF-LQRPolicy} \cite{Singh2017}:

\begin{equation}
	u(k) = \sum_{i=1}^{k} \tilde{u}^*(k) - B^\dagger \mathcal{B}\delta(k)
\end{equation}

where $B^\dagger$ is the Moore-Penrose pseudoinverse of $B$ and $\mathcal{B}$ is the disturbance input matrix. The value of this disturbance can be estimated in one of two ways depending on whether a general model of the disturbance is known. If no model is assumed, and assuming that $\delta(k) \approx \delta(k+1)$, \cref{eq:TankPressureDyn} can be manipulated to yield:

\begin{equation}\label{eq:AgnosticDisturbanceEstimation}
	\hat{d}_c = B_c^\dagger (\Delta p(k) - Bd_p(k))
\end{equation}

This scheme, however, clearly maps any measurement noise directly into $\hat{d}_c$, and furthermore must be expected to be inherently noisy due to the $\Delta p$ term. As an alternative, we can exploit the knowledge that consumer demand is often approximately cosinusoidal, and build a disturbance estimator based on the model $\hat{d}_c = \beta + \alpha\cos(\omega t)$, which in the single-frequency case can be represented by the state-space model:

\begin{equation}\label{eq:TheisticDisturbanceEstimator}
	\begin{gathered}
		\dot{x} = A_\delta x =  \begin{bmatrix}0 & 0 & 0 \\ 0 & 0 & -\omega \\ 0 & \omega & 0	\end{bmatrix}x \\
		\hat{d}_c = C_\delta x = \begin{bmatrix} 1 & 1 & 0 \end{bmatrix} x
	\end{gathered}
\end{equation}

where $x = \begin{bmatrix}\beta & \alpha \cos(\omega t) & \alpha \sin(\omega t)\end{bmatrix}^T$. If this is discretised with Euler's method, the state equation becomes:

\begin{equation}\label{eq:TheisticDisturbanceEstimatorDiscrete}
	x(k+1) = \Big(I_{n\times n} + A_\delta t_s \Big) x(k) = \mathcal{A}_\delta x(k)
\end{equation}

And a discrete-time Kalman filter can then be constructed from $\{\mathcal{A}_\delta,C_\delta\}$ and appropriate noise models. \Cref{eq:TheisticDisturbanceEstimator} can be extended to the harmonic case by block-diagonal concatenation of several signal models, i.e. in the one-harmonic case:

\begin{equation}\label{eq:DisturbanceVectorCase}
	\begin{gathered}
		\begin{bmatrix} \beta \\ \dot{x}_1 \\ \dot{x}_2 \end{bmatrix} = \begin{bmatrix} A_{\delta_1} & 0 \\ 0 & \bar{A}_{\delta_2} \end{bmatrix} \begin{bmatrix}\beta \\ x_1 \\ x_2 \end{bmatrix},
		 \quad y = C_\delta \begin{bmatrix}\beta \\ x_1 \\ x_2 \end{bmatrix} \\
		 x_1, x_2 \in \mathbb{R}^{2\times1} \\
		 A_{\delta_1} \in \mathbb{R}^{3\times3}, \quad \forall i \neq 1: \ \bar{A}_{\delta_i} \in \mathbb{R}^{2\times2} \\
		 C_\delta \in \mathbb{R}^{1\times2n+1}
	\end{gathered}
\end{equation}


\subsection{Inner Loop}\label{subsec:InnerLoop}

We now address the inner loop and its PID controllers. The model used for their design is the state-space model of the fast dynamics given in \cref{eq:LinearisedModelWithTank}, with a Pad√© approximation of a $4$-second output delay $T_{delay}$ included. This state-space system with output delay can be converted into the frequency-domain transfer matrix $G(s)$:

\begin{equation}\label{eq:TransferMatrix}
	G(s) = \begin{bmatrix} G_{11}(s) & G_{12}(s) \\ G_{21}(s) & G_{22}(s)\end{bmatrix}
\end{equation}

which can be shown to be approximately diagonal as per \cref{fig:BodeMagDelayPlot}:

\begin{figure}[h!]
 	\centering
 	\includegraphics[width=\linewidth,height=4cm]{Graphics/PumpMagPlot.pdf}
 	\caption{Transfer matrix magnitude plots, output delay included.}
 	\label{fig:BodeMagDelayPlot}
\end{figure}

On account of this the PID controllers for pump speeds $\omega_1$ and $\omega_2$ can be designed as decentralised SISO controllers without decoupling. Their poles and zeros are respectively:

\begin{equation}\label{eq:PumpTFNumDen}
	\begin{gathered}
		z_{11} = \begin{bmatrix}-18.92 & -14.00 & -0.56 & -0.34 & -0.19	\end{bmatrix} \\
		z_{22} = \begin{bmatrix}-20.72 & -14.10 & -0.41 & -0.36 & -0.16	\end{bmatrix} \\
		p_{11} = \begin{bmatrix}-20.77 & -14.86 & -0.56 & -0.39 & -0.33 & -0.16\end{bmatrix} \\
		p_{22} = \begin{bmatrix}-20.77 & -14.86 & -0.56 & -0.39 & -0.33 & -0.16\end{bmatrix}
	\end{gathered}
\end{equation}

Clearly many of these poles and zeros are approximately cancelling, and \cref{fig:BodeMagDelayPlot} indicates that $G_{11}(s) \approx G_{22}(s)$, so \cref{eq:PumpTFNumDen} can, for design purposes, be simplified to:

\begin{equation}\label{eq:PumpTFSimple}
	\begin{gathered}
		z_{11} = z_{22} = \begin{bmatrix}-0.19\end{bmatrix} \\
		p_{11} = p_{22} = \begin{bmatrix}-0.39 & -0.16 \end{bmatrix}
	\end{gathered}
\end{equation}

A PI controller is designed (i.e., the D term is $0$) via the root-locus method with the goal of no overshoot to avoid ringing and accompanying pressure oscillations in the pipes. To accommodate the presence of an outer loop and allow this to operate at a reasonable sample rate, a bandwidth of $0.05 \frac{\si{rad}}{\si{s}}$ is chosen. Note that per \cite{Skogestad2005}, a stable controller cannot be designed with a closed-loop bandwidth higher than $\frac{1}{T_{delay}} = 0.25 \frac{\si{rad}}{\si{s}}$. The resulting controller is:

\begin{equation}\label{eq:PIDTransferFunction}
	C(s) = 1.8\frac{s+0.125}{s}
\end{equation}

\subsection{Outer Loop Stability Under Packet Loss}\label{subsec:PacketLossStability}

Until now we have assumed that there are no meaningful losses attributable to communication between the elements of the control system. This assumption is counterfactual, as the outer and inner loops of the proposed control structure are likely to be located some physical distance from each other, and may be communicating over WiFi.

A study by Anmon Sheth et al. \cite{Sheth2007} has examined the real-world packet loss experienced by WiFi-based Long Distance Networks (WiLD) using the MAC $802.11$ protocol. They find negligible losses in a rural setting, but find significant losses in an urban environment. The loss rate scales exponentially with distance, from a worst-case loss rate of $7\%$ at $2\si{km}$, $15\%$ at $8\si{km}$, to $60\%$ at $20\si{km}$. Considering these losses as an upper bound $\alpha$ on possible loss, Hu and Yan \cite{Hu2007} give a sufficient condition for the stability of the outer loop in the mean-square sense if a Try-Once-Discard protocol is assumed:

\begin{equation}\label{eq:HuStabCondition}
	\mathcal{S}\Big(\alpha A \otimes A + (1-\alpha)(A-BK) \otimes (A-BK) \Big) < 1
\end{equation}

where $\mathcal{S}$ is the spectral radius and $\otimes$ is the Kronecker product. Applying this theorem, we can show that the VF-LQR system is stable for the given values of packet loss, with spectral radii of $\{0.9238,0.9271,0.9453\}$. In fact, we can show that the VF-LQR system should be stable for \textit{any} value of packet loss. Assuming that the nominal system $A-BK$ is stable, applying Theorem 6 in \cite{Hu2007} gives the upper stability bound $PDM$ as: 

\begin{equation}\label{eq:VMatrix}
	\begin{gathered}
		PDM = \frac{1}{\text{max}(\sigma(V))} \\
		V = \begin{bmatrix} (S\otimes\hat{S}+\hat{S} \otimes S)(I - S\otimes S)^{-1} & \hat{S}\otimes\hat{S} \\ (I - S\otimes S)^{-1} & 0 \end{bmatrix} \\
		S = \left(A-BK\right) \otimes \left(A-BK\right), \quad \hat{S} = A \otimes A - S
	\end{gathered}
\end{equation}

Where $\text{max}(\sigma(V))$ is the largest positive eigenvalue of $V$. In our case this is $\text{max}(\sigma(V)) = 0.81$ and thus $PDM = \frac{1}{\text{max}(\sigma(V))} = 1.24$, implying mean-square stability for arbitrarily large packet loss.




